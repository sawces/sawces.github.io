<!DOCTYPE html>
<html>
  <head>
    <base target="_top">
    <meta charset="UTF-8">
    <title>Ascension Celestials Raid</title>
    <!-- Import fonts from Google Fonts -->
    <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto|Open+Sans">
    <style>
      /* Main page styling */
      body {
        margin: 0;
        background-color: #000;
        color: #fff;
        font-family: 'Roboto', 'Open Sans', sans-serif;
        text-align: center;
      }
      h1 {
        margin-bottom: 20px;
      }
      
      /* Navigation tabs */
      #nav {
        display: flex;
        margin: 0;
      }
      #nav button {
        margin-right: 2px;
        padding: 10px 15px;
        border: none;
        border-top-left-radius: 5px;
        border-top-right-radius: 5px;
        background-color: #ddd;
        color: #000;
        font-size: 1em;
        cursor: pointer;
      }
      #nav button.currentTab {
        background-color: rgb(28, 69, 135);
        font-weight: bold;
        color: #fff;
      }
      
      /* Table styling */
      table {
        border-collapse: collapse;
        width: 100%;
      }
      th, td {
        border: 1px solid #000;
        padding: 8px;
      }
      .header-row {
        background-color: #f4f4f4;
        font-weight: bold;
      }
      .data-row { }
      
      #content {
        margin-top: 0;
      }
      #content.loading {
        font-size: 2em;
        display: flex;
        align-items: center;
        justify-content: center;
        min-height: 80vh;
      }
      
      /* Force black background for specific cells */
      .force-black {
        background-color: #000 !important;
      }
      
      /* CSS to force "Select #" cell background */
      .select-cell {
        background-color: #434343 !important;
      }
      
      /* Icon Sprite CSS for 64x64 icons */
      .icon-64 {
        display: inline-block;
        width: 64px;
        height: 64px;
        background-image: url("https://static.wikia.nocookie.net/wowwiki/images/8/8b/UI-RaidTargetingIcons.png");
        background-size: 256px 128px;
        background-repeat: no-repeat;
        margin: 0 5px;
      }
      .icon-64.icon-star    { background-position: 0 0; }
      .icon-64.icon-circle  { background-position: -64px 0; }
      .icon-64.icon-diamond { background-position: -128px 0; }
      .icon-64.icon-triangle{ background-position: -192px 0; }
      .icon-64.icon-moon    { background-position: 0 -64px; }
      .icon-64.icon-square  { background-position: -64px -64px; }
      .icon-64.icon-cross   { background-position: -128px -64px; }
      .icon-64.icon-skull   { background-position: -192px -64px; }
      
      /* Icon Sprite CSS for 16x16 icons */
      .icon-16 {
        display: inline-block;
        width: 16px;
        height: 16px;
        background-image: url("https://static.wikia.nocookie.net/wowwiki/images/8/8b/UI-RaidTargetingIcons.png");
        background-size: 64px 32px;
        background-repeat: no-repeat;
        margin-right: 5px;
        margin-bottom: 3px;
        vertical-align: middle;
      }
      .icon-16.icon-star    { background-position: 0 0; }
      .icon-16.icon-circle  { background-position: -16px 0; }
      .icon-16.icon-diamond { background-position: -32px 0; }
      .icon-16.icon-triangle{ background-position: -48px 0; }
      .icon-16.icon-moon    { background-position: 0 -16px; }
      .icon-16.icon-square  { background-position: -16px -16px; }
      .icon-16.icon-cross   { background-position: -32px -16px; }
      .icon-16.icon-skull   { background-position: -48px -16px; }
    </style>
    <script>
      // Set document title dynamically.
      document.title = "Ascension Celestials Raid";

      // Helper: Convert 0-based column index to letter.
      function columnIndexToLetter(index) {
        var letter = "";
        while (index >= 0) {
          letter = String.fromCharCode((index % 26) + 65) + letter;
          index = Math.floor(index / 26) - 1;
        }
        return letter;
      }
      
      // Safe localStorage functions.
      function safeGetItem(key) {
        try {
          return localStorage.getItem(key);
        } catch (e) {
          console.warn("localStorage unavailable:", e);
          return null;
        }
      }
      
      function safeSetItem(key, value) {
        try {
          localStorage.setItem(key, value);
        } catch (e) {
          console.warn("localStorage unavailable:", e);
        }
      }
      
      // Global variables.
      var currentSheetName = "";
      var lastDataHash = "";
      
      // Sheet configuration.
      var sheetConfigs = [
        { name: "Raid Roster", headerRowCount: 2, noAlternateColumns: ["A", "C", "D", "E", "F", "G"], sortable: true },
        { name: "Raid Assignments", headerRowCount: 1, noAlternateColumns: [], sortable: false },
        { name: "Loot Distribution", headerRowCount: 3, noAlternateColumns: ["A", "B", "C"], sortable: true },
        { name: "Loot History", headerRowCount: 4, noAlternateColumns: ["D", "E"], sortable: true },
        { name: "MC & Ony Priority", headerRowCount: 2, noAlternateColumns: [], sortable: false },
        { name: "BWL Priority", headerRowCount: 2, noAlternateColumns: [], sortable: false }
      ];
      
      var renderedHeaderNames = [];
      var lastHeaderRowElement = null;
      
      function buildNav() {
        var navContainer = document.getElementById('nav');
        navContainer.innerHTML = '';
        sheetConfigs.forEach(function(config) {
          var button = document.createElement('button');
          button.textContent = config.name;
          if (config.name === currentSheetName) {
            button.classList.add('currentTab');
          }
          // Update localStorage when clicking a tab.
          button.onclick = function() {
            safeSetItem('currentSheet', config.name);
            loadSheetData(config.name, config.headerRowCount);
          };
          navContainer.appendChild(button);
        });
      }
      
      function loadSheetData(sheetName, headerRowCount) {
        currentSheetName = sheetName;
        buildNav();
        var contentDiv = document.getElementById('content');
        contentDiv.classList.add("loading");
        contentDiv.textContent = 'Loading data from "' + sheetName + '"...';
        google.script.run
          .withSuccessHandler(function(result) {
            onSuccess(result, headerRowCount);
          })
          .withFailureHandler(onError)
          .getSheetDataWithFormat(sheetName);
      }
      
      function onSuccess(result, headerRowCount) {
        document.getElementById('message').textContent = '';
        lastDataHash = result.dataHash;
        var contentDiv = document.getElementById('content');
        contentDiv.classList.remove("loading");
        renderTableWithFormat(result, headerRowCount);
        var currentConfig = sheetConfigs.find(function(c) {
          return c.name === currentSheetName;
        });
        if (currentConfig && currentConfig.sortable) {
          attachSorting();
        }
      }
      
      function onError(error) {
        document.getElementById('message').textContent = "Error: " + error.message;
        document.getElementById('content').innerHTML = '';
      }
      
      function renderTableWithFormat(result, headerRowCount) {
        var data = result.data;
        var mergeInfo = result.mergeInfo;
        var formatting = result.formatting;
        var hyperlinks = result.hyperlinks;
        var contentDiv = document.getElementById('content');
        contentDiv.innerHTML = '';
        if (!data || data.length === 0) {
          contentDiv.textContent = 'No data available.';
          return;
        }
        var currentConfig = sheetConfigs.find(function(c) { return c.name === currentSheetName; });
        var noAltCols = currentConfig ? currentConfig.noAlternateColumns : [];
        
        var table = document.createElement('table');
        var thead = document.createElement('thead');
        renderedHeaderNames = [];
        var headerRowRendered = 0;
        for (var i = 0; i < headerRowCount; i++) {
          var headerRow = document.createElement('tr');
          headerRow.classList.add('header-row');
          
          // For "Raid Assignments", skip column A (start at index 1)
          // Special merging for header row 0: merge cells from column B through second-to-last,
          // and render the last cell ("LC") normally.
          if (currentSheetName === "Raid Assignments" && i === 0) {
            var totalColumns = data[i].length;
            if (totalColumns > 2 && data[i][1] !== null) {
              var thMerged = document.createElement('th');
              thMerged.colSpan = totalColumns - 2;
              var urlText = data[i][2] ? data[i][2].trim() : "";
              var hyperlink = "";
              if (result.hyperlinks && result.hyperlinks[i] && result.hyperlinks[i][2]) {
                hyperlink = result.hyperlinks[i][2];
              }
              thMerged.innerHTML = 'RaidPlan URL: ' + (hyperlink ? '<a href="' + hyperlink + '" target="_blank" style="color:inherit; text-decoration:underline;">' + urlText + '</a>' : urlText);
              thMerged.style.textAlign = "left";
              thMerged.style.backgroundColor = formatting.backgrounds[i][1] || "#f4f4f4";
              thMerged.style.color = formatting.fontColors[i][1];
              thMerged.style.fontFamily = formatting.fontFamilies[i][1];
              headerRow.appendChild(thMerged);
            }
            if (data[i][totalColumns - 1] !== null) {
              var thLast = document.createElement('th');
              thLast.textContent = data[i][totalColumns - 1];
              thLast.style.textAlign = "center";
              thLast.style.backgroundColor = formatting.backgrounds[i][totalColumns - 1] || "#f4f4f4";
              thLast.style.color = formatting.fontColors[i][totalColumns - 1];
              thLast.style.fontFamily = formatting.fontFamilies[i][totalColumns - 1];
              headerRow.appendChild(thLast);
            }
            renderedHeaderNames = [ thMerged.textContent, thLast.textContent ];
          } else {
            // Default header row rendering.
            if (currentSheetName === "Loot History" && i === 1) { continue; }
            var startIndex = (currentSheetName === "Raid Assignments" && i === 0) ? 1 : 0;
            for (var j = startIndex; j < data[i].length; j++) {
              if (data[i][j] === null) continue;
              var th = document.createElement('th');
              var key = i + "," + j;
              if (mergeInfo && mergeInfo[key]) {
                th.rowSpan = mergeInfo[key].rowspan;
                th.colSpan = mergeInfo[key].colspan;
                for (var r = i; r < i + mergeInfo[key].rowspan; r++) {
                  for (var c = j; c < j + mergeInfo[key].colspan; c++) {
                    if (r === i && c === j) continue;
                    data[r][c] = null;
                  }
                }
              }
              th.textContent = data[i][j];
              th.style.backgroundColor = formatting.backgrounds[i][j] || "#f4f4f4";
              th.style.color = formatting.fontColors[i][j];
              th.style.fontFamily = formatting.fontFamilies[i][j];
              th.style.textAlign = formatting.alignments[i][j];
              headerRow.appendChild(th);
              if (i === headerRowCount - 1) {
                renderedHeaderNames[j] = data[i][j].trim();
              }
            }
          }
          if (headerRowRendered === 0) {
            for (var k = 0; k < headerRow.children.length; k++) {
              headerRow.children[k].style.borderTop = "none";
            }
          }
          thead.appendChild(headerRow);
          headerRowRendered++;
          lastHeaderRowElement = headerRow;
        }
        table.appendChild(thead);
        
        var tbody = document.createElement('tbody');
        for (var i = headerRowCount; i < data.length; i++) {
          var tr = document.createElement('tr');
          tr.classList.add('data-row');
          var startIndex = (currentSheetName === "Raid Assignments") ? 1 : 0;
          for (var j = startIndex; j < data[i].length; j++) {
            if (data[i][j] === null) continue;
            var td = document.createElement('td');
            var key = i + "," + j;
            if (mergeInfo && mergeInfo[key]) {
              td.rowSpan = mergeInfo[key].rowspan;
              td.colSpan = mergeInfo[key].colspan;
              for (var r = i; r < i + mergeInfo[key].rowspan; r++) {
                for (var c = j; c < j + mergeInfo[key].colspan; c++) {
                  if (r === i && c === j) continue;
                  data[r][c] = null;
                }
              }
            }
            // For Raid Assignments: insert an icon if text matches an icon name,
            // and for cells matching "Select #" remove text and force background to #434343.
            if (currentSheetName === "Raid Assignments") {
              var label = data[i][j].trim();
              var lower = label.toLowerCase();
              var iconNames = ["star", "circle", "diamond", "triangle", "moon", "square", "cross", "skull"];
              if (iconNames.indexOf(lower) !== -1) {
                td.innerHTML = '<span class="icon-16 icon-' + lower + '" style="margin-right:5px; margin-bottom:3px;"></span>' + label;
              } else if (/^select \d+$/i.test(label)) {
                td.textContent = "";
                td.classList.add("select-cell");
              } else {
                td.textContent = data[i][j];
              }
            }
            // For Loot History, if column C (index 2) has a hyperlink, render as a link.
            else if (currentSheetName === "Loot History" && j === 2 && hyperlinks && hyperlinks[i] && hyperlinks[i][j]) {
              td.innerHTML = '<a href="' + hyperlinks[i][j] + '" target="_blank" style="color:inherit; text-decoration:underline;">' + data[i][j] + '</a>';
            } else {
              td.textContent = data[i][j];
            }
            var cellBg = formatting.backgrounds[i][j];
            var colLetter = columnIndexToLetter(j);
            if ((!cellBg || cellBg.trim() === "" || cellBg.toLowerCase() === "#ffffff") &&
                noAltCols.indexOf(colLetter) === -1) {
              var altIndex = i - headerRowCount;
              cellBg = (altIndex % 2 === 0) ? "#F1F1F1" : "#D9D9D9";
              td.setAttribute("data-fallback", "true");
            }
            td.style.backgroundColor = cellBg;
            td.style.color = formatting.fontColors[i][j];
            td.style.fontFamily = formatting.fontFamilies[i][j];
            td.style.textAlign = formatting.alignments[i][j];
            tr.appendChild(td);
          }
          tbody.appendChild(tr);
        }
        table.appendChild(tbody);
        contentDiv.appendChild(table);
        
        // Post-process for "Raid Assignments": 
        // Look for a row in the tbody that contains "Default Assignments"
        // and force the row immediately above it to have a black background.
        if (currentSheetName === "Raid Assignments") {
          var rows = contentDiv.querySelectorAll("tbody tr");
          for (var i = 0; i < rows.length - 1; i++) {
            var nextRowText = rows[i + 1].textContent;
            if (nextRowText && nextRowText.indexOf("Default Assignments") !== -1) {
              rows[i].querySelectorAll("td, th").forEach(function(cell) {
                cell.classList.add("force-black");
              });
            }
          }
        }
      }
      
      function attachSorting() {
        if (!lastHeaderRowElement) return;
        var thElements = lastHeaderRowElement.children;
        for (var i = 0; i < thElements.length; i++) {
          (function(colIndex) {
            var th = thElements[colIndex];
            th.style.cursor = "pointer";
            th.addEventListener("click", function() {
              sortTableByColumn(colIndex);
            });
          })(i);
        }
      }
      
      function sortTableByColumn(colIndex) {
        var table = document.querySelector("#content table");
        if (!table) return;
        var tbody = table.querySelector("tbody");
        var rows = Array.from(tbody.querySelectorAll("tr"));
        var th = lastHeaderRowElement.children[colIndex];
        var currentSort = th.getAttribute("data-sort") || "asc";
        var newSort = currentSort === "asc" ? "desc" : "asc";
        th.setAttribute("data-sort", newSort);
        
        rows.sort(function(rowA, rowB) {
          var cellA = rowA.querySelectorAll("td")[colIndex];
          var cellB = rowB.querySelectorAll("td")[colIndex];
          var textA = cellA ? cellA.textContent.trim() : "";
          var textB = cellB ? cellB.textContent.trim() : "";
          var numA = parseFloat(textA);
          var numB = parseFloat(textB);
          if (!isNaN(numA) && !isNaN(numB)) {
            return newSort === "asc" ? numA - numB : numB - numA;
          } else {
            return newSort === "asc" ? textA.localeCompare(textB) : textB.localeCompare(textA);
          }
        });
        
        rows.forEach(function(row) {
          tbody.appendChild(row);
        });
        
        for (var i = 0; i < lastHeaderRowElement.children.length; i++) {
          var headerCell = lastHeaderRowElement.children[i];
          if (i === colIndex) {
            headerCell.innerHTML = renderedHeaderNames[i] + (newSort === "asc" ? " &#9650;" : " &#9660;");
          } else {
            headerCell.innerHTML = renderedHeaderNames[i];
          }
        }
        
        rows.forEach(function(row, index) {
          var fallbackColor = (index % 2 === 0) ? "#F1F1F1" : "#D9D9D9";
          row.querySelectorAll("td").forEach(function(td) {
            if (td.getAttribute("data-fallback") === "true") {
              td.style.backgroundColor = fallbackColor;
            }
          });
        });
      }
      
      function pollForUpdates() {
        google.script.run
          .withSuccessHandler(function(result) {
            if (result.dataHash !== lastDataHash) {
              document.getElementById('message').textContent = 'Changes to this sheet (' + currentSheetName + ') have been made. Automatically loading the updates now...';
              lastDataHash = result.dataHash;
              var currentConfig = sheetConfigs.find(function(c) { return c.name === currentSheetName; });
              loadSheetData(currentSheetName, currentConfig ? currentConfig.headerRowCount : 1);
            }
          })
          .withFailureHandler(function(err) {
            console.error("Error polling for updates: " + err);
          })
          .getSheetDataWithFormat(currentSheetName);
      }
      
      setInterval(pollForUpdates, 60000);
      
      window.onload = function() {
        // On load, check localStorage for the current sheet.
        var savedSheet = safeGetItem('currentSheet');
        if (savedSheet) {
          currentSheetName = savedSheet;
        }
        buildNav();
        var config = sheetConfigs[0];
        if (currentSheetName) {
          var cfg = sheetConfigs.find(function(c) { return c.name === currentSheetName; });
          if (cfg) {
            config = cfg;
          }
        }
        loadSheetData(config.name, config.headerRowCount);
      };
    </script>
  </head>
  <body>
    <h1>Ascension Celestials Raid</h1>
    <div id="nav"></div>
    <div id="content">Loading data...</div>
    <div id="message"></div>
  </body>
</html>

